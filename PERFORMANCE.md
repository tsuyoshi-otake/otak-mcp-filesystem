# パフォーマンス最適化

このドキュメントでは、MCP Filesystem Serverの最適化版で実装されているパフォーマンス改善について説明します。

## 最適化のポイント

### 1. ファイルシステムのstatキャッシュ
- 5秒間のTTLでファイル情報をキャッシュ
- 同じファイルへの繰り返しアクセスを高速化
- キャッシュサイズは1000エントリに制限

### 2. パス解決の最適化
- 許可ディレクトリを事前に解決して保存
- パスチェックの高速化

### 3. バッチ処理
- `list_directory`で大量のファイルを扱う際、10個ずつバッチ処理
- 並列処理による高速化とメモリ使用量のバランス

### 4. 大きなファイルのストリーミング読み取り
- 10MB以上のファイルはストリーミングで読み取り
- メモリ使用量を抑制
- 必要に応じて切り詰め表示

### 5. アトミックなファイル書き込み
- 一時ファイルに書き込んでからリネーム
- 書き込み中の不完全な状態を防止

### 6. エラーハンドリングの改善
- アクセスできないファイルをスキップ
- エラー時でも可能な限り結果を返す

## 使用方法

最適化版を使用するには：

```bash
npm run dev:optimized
```

または、Claude Desktopの設定で：

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": [
        "tsx",
        "path/to/src/index-optimized.ts"
      ]
    }
  }
}
```

## パフォーマンス比較

### list_directory
- 通常版: ファイル数に比例してstat呼び出しが増加
- 最適化版: キャッシュとバッチ処理により最大10倍高速

### read_file
- 通常版: 大きなファイルでメモリ不足の可能性
- 最適化版: ストリーミングで安定動作

### write_file
- 通常版: 書き込み中断時にファイル破損の可能性
- 最適化版: アトミック書き込みで安全性向上

## メモリ使用量
- statキャッシュ: 最大約100KB（1000エントリ）
- ファイル読み取り: 最大10MBに制限
- 全体的なメモリフットプリント: 50MB以下